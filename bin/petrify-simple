#!/usr/bin/env ruby

require "optparse"

$:.unshift(File.join(File.dirname(__FILE__), "..", "lib"))
require "petrify_simple"

opts = {}
ARGV.options do |o|
  o.set_summary_indent("  ")
  o.banner = "Usage: PETRIFY_PUT_URL=<url> #{$0} --file <path> --snapshot-interval <secs> [--quiet]\n"
  o.on("-f", "--file=path", String, "Path to append-only file") { |f| opts[:path] = f }
  o.on("-s", "--snapshot-interval=secs", Integer, "Seconds between snapshots") { |s| opts[:snapshot_interval] = s }
  o.on("-q", "--quiet", "Suppress logs") { opts[:quiet] = true }
  o.on("-h", "--help", "Show this help message") { abort(o.to_s) }
  o.separator("")
  o.parse!
  opts[:put_url] = ENV["PETRIFY_PUT_URL"]
  abort(o.to_s) if (!ARGV.empty? || !opts[:path] || !opts[:snapshot_interval])
end

PetrifySimple.new(opts).persist
